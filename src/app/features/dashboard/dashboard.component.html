<div class="dashboard-container animate-fade-in">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-on-surface mb-2">Dashboard</h1>
        <p class="text-on-surface-variant">Panoramica della tua attività di fatturazione</p>
    </div>

    @if (loading()) {
    <!-- Loading State -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        @for (i of [1,2,3,4]; track i) {
        <mat-card class="surface-container">
            <mat-card-content class="p-6">
                <div class="loading-shimmer w-full h-20 rounded-lg"></div>
            </mat-card-content>
        </mat-card>
        }
    </div>
    } @else {
    <!-- Stats Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total Revenue -->
        <mat-card class="stats-card surface-container cursor-pointer" (click)="goToInvoices()">
            <mat-card-content class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 rounded-lg bg-primary/10">
                        <mat-icon class="text-primary">euro</mat-icon>
                    </div>
                    @if (stats().thisMonthRevenue > 0) {
                    <span class="text-sm text-green-600">+{{ calculateMonthlyGrowth() | number:'1.1-1' }}%</span>
                    }
                </div>
                <h3 class="text-2xl font-bold text-on-surface mb-1">
                    €{{ stats().totalRevenue | number:'1.2-2' }}
                </h3>
                <p class="text-sm text-on-surface-variant">Fatturato totale</p>
                @if (stats().thisMonthRevenue > 0) {
                <p class="text-xs text-green-600 mt-1">
                    €{{ stats().thisMonthRevenue | number:'1.2-2' }} questo mese
                </p>
                }
            </mat-card-content>
        </mat-card>

        <!-- Total Invoices -->
        <mat-card class="stats-card surface-container cursor-pointer" (click)="goToInvoices()">
            <mat-card-content class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 rounded-lg bg-secondary/10">
                        <mat-icon class="text-secondary">receipt_long</mat-icon>
                    </div>
                    <span class="text-sm text-on-surface-variant">Totali</span>
                </div>
                <h3 class="text-2xl font-bold text-on-surface mb-1">
                    {{ stats().totalInvoices }}
                </h3>
                <p class="text-sm text-on-surface-variant">Fatture create</p>
            </mat-card-content>
        </mat-card>

        <!-- Pending Invoices -->
        <mat-card class="stats-card surface-container cursor-pointer" (click)="goToPendingInvoices()">
            <mat-card-content class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 rounded-lg bg-orange-100">
                        <mat-icon class="text-orange-600">schedule</mat-icon>
                    </div>
                    @if (stats().pendingInvoices > 0) {
                    <mat-chip class="bg-orange-100 text-orange-800 text-xs">{{ stats().pendingInvoices }}</mat-chip>
                    }
                </div>
                <h3 class="text-2xl font-bold text-on-surface mb-1">
                    {{ stats().pendingInvoices }}
                </h3>
                <p class="text-sm text-on-surface-variant">In attesa di pagamento</p>
            </mat-card-content>
        </mat-card>

        <!-- Overdue Invoices -->
        <mat-card class="stats-card surface-container cursor-pointer" (click)="goToOverdueInvoices()">
            <mat-card-content class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <div class="p-3 rounded-lg bg-red-100">
                        <mat-icon class="text-red-600">warning</mat-icon>
                    </div>
                    @if (stats().overdueInvoices > 0) {
                    <mat-chip class="bg-red-100 text-red-800 text-xs">Attenzione!</mat-chip>
                    }
                </div>
                <h3 class="text-2xl font-bold text-on-surface mb-1">
                    {{ stats().overdueInvoices }}
                </h3>
                <p class="text-sm text-on-surface-variant">Fatture scadute</p>
            </mat-card-content>
        </mat-card>
    </div>
    }

    <!-- Quick Actions & Recent Items -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Quick Actions -->
        <mat-card class="surface-container">
            <mat-card-header>
                <mat-card-title class="text-on-surface">Azioni rapide</mat-card-title>
            </mat-card-header>
            <mat-card-content class="p-6">
                <div class="grid grid-cols-2 gap-4">
                    <button mat-raised-button color="primary" (click)="createNewInvoice()" class="h-16 flex-col">
                        <mat-icon>add</mat-icon>
                        <span class="mt-1 text-sm">Nuova Fattura</span>
                    </button>

                    <button mat-outlined-button (click)="goToCustomers()" class="h-16 flex-col">
                        <mat-icon>person_add</mat-icon>
                        <span class="mt-1 text-sm">Gestisci Clienti</span>
                    </button>

                    <button mat-outlined-button (click)="goToPendingInvoices()" class="h-16 flex-col">
                        <mat-icon>schedule</mat-icon>
                        <span class="mt-1 text-sm">In Attesa</span>
                        @if (stats().pendingInvoices > 0) {
                        <mat-chip class="mt-1 text-xs bg-orange-100 text-orange-800">{{ stats().pendingInvoices
                            }}</mat-chip>
                        }
                    </button>

                    <button mat-outlined-button routerLink="/reports" class="h-16 flex-col">
                        <mat-icon>analytics</mat-icon>
                        <span class="mt-1 text-sm">Report</span>
                    </button>
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Recent Invoices -->
        <mat-card class="surface-container">
            <mat-card-header class="flex justify-between items-center">
                <mat-card-title class="text-on-surface">Fatture recenti</mat-card-title>
                <button mat-button (click)="goToInvoices()" class="text-primary">
                    Vedi tutte
                </button>
            </mat-card-header>
            <mat-card-content class="p-6">
                @if (loading()) {
                <div class="space-y-4">
                    @for (i of [1,2,3]; track i) {
                    <div class="loading-shimmer w-full h-16 rounded-lg"></div>
                    }
                </div>
                } @else if (recentInvoices().length > 0) {
                <div class="space-y-4">
                    @for (invoice of recentInvoices(); track invoice.id) {
                    <div class="flex items-center justify-between p-3 rounded-lg hover:bg-surface-container-high cursor-pointer transition-colors"
                        (click)="navigateToInvoice(invoice.id!)">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                                <mat-icon class="text-primary text-sm">receipt</mat-icon>
                            </div>
                            <div>
                                <p class="font-medium text-on-surface">{{ invoice.invoice_number }}</p>
                                <p class="text-sm text-on-surface-variant">
                                    {{ invoice.customer?.name || 'Cliente non specificato' }}
                                </p>
                                @if (invoice.due_date && invoice.status === 'sent') {
                                <p class="text-xs" [class]="getDaysToDeadlineClass(invoice)">
                                    {{ getDaysToDeadlineText(invoice) }}
                                </p>
                                }
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-medium text-on-surface">€{{ invoice.total | number:'1.2-2' }}</p>
                            <mat-chip [class]="getStatusClass(invoice.status)" class="text-xs">
                                {{ getStatusLabel(invoice.status) }}
                            </mat-chip>
                        </div>
                    </div>
                    }
                </div>
                } @else {
                <div class="text-center py-8">
                    <mat-icon class="text-6xl text-on-surface-variant mb-4">receipt_long</mat-icon>
                    <p class="text-on-surface-variant mb-4">Nessuna fattura ancora creata</p>
                    <button mat-raised-button color="primary" (click)="createNewInvoice()">
                        Crea la prima fattura
                    </button>
                </div>
                }
            </mat-card-content>
        </mat-card>
    </div>

    <!-- Additional Dashboard Widgets -->
    @if (!loading() && stats().totalInvoices > 0) {
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
        <!-- This Month Summary -->
        <mat-card class="surface-container">
            <mat-card-header>
                <mat-card-title class="text-on-surface">Questo Mese</mat-card-title>
            </mat-card-header>
            <mat-card-content class="p-6">
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-on-surface-variant">Fatturato:</span>
                        <span class="font-bold text-lg text-primary">€{{ stats().thisMonthRevenue | number:'1.2-2'
                            }}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-on-surface-variant">Clienti attivi:</span>
                        <span class="font-medium text-on-surface">{{ stats().totalCustomers }}</span>
                    </div>
                    @if (stats().overdueInvoices > 0) {
                    <div class="p-3 bg-red-50 rounded-lg border-l-4 border-red-400">
                        <div class="flex items-center gap-2">
                            <mat-icon class="text-red-600 text-sm">warning</mat-icon>
                            <span class="text-sm text-red-700 font-medium">
                                {{ stats().overdueInvoices }} fattura/e scaduta/e
                            </span>
                        </div>
                        <button mat-button class="text-red-600 text-xs mt-1 p-0 min-w-0"
                            (click)="goToOverdueInvoices()">
                            Gestisci ora →
                        </button>
                    </div>
                    }
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Revenue Progress -->
        <mat-card class="surface-container">
            <mat-card-header>
                <mat-card-title class="text-on-surface">Andamento</mat-card-title>
            </mat-card-header>
            <mat-card-content class="p-6">
                <div class="space-y-4">
                    @if (stats().totalRevenue > 0) {
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-on-surface-variant">Pagate</span>
                            <span class="text-green-600">{{ getPaidPercentage() | number:'1.0-0' }}%</span>
                        </div>
                        <div class="w-full bg-surface-container-high rounded-full h-2">
                            <div class="bg-green-500 h-2 rounded-full" [style.width.%]="getPaidPercentage()"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-on-surface-variant">In attesa</span>
                            <span class="text-orange-600">{{ getPendingPercentage() | number:'1.0-0' }}%</span>
                        </div>
                        <div class="w-full bg-surface-container-high rounded-full h-2">
                            <div class="bg-orange-500 h-2 rounded-full" [style.width.%]="getPendingPercentage()"></div>
                        </div>
                    </div>
                    } @else {
                    <div class="text-center py-4">
                        <mat-icon class="text-4xl text-on-surface-variant mb-2">trending_up</mat-icon>
                        <p class="text-sm text-on-surface-variant">Inizia a fatturare per vedere i progressi</p>
                    </div>
                    }
                </div>
            </mat-card-content>
        </mat-card>

        <!-- Quick Links -->
        <mat-card class="surface-container">
            <mat-card-header>
                <mat-card-title class="text-on-surface">Accesso Rapido</mat-card-title>
            </mat-card-header>
            <mat-card-content class="p-6">
                <div class="space-y-3">
                    <button mat-stroked-button class="w-full justify-start" routerLink="/products">
                        <mat-icon>inventory_2</mat-icon>
                        <span class="ml-2">Gestisci Prodotti</span>
                    </button>
                    <button mat-stroked-button class="w-full justify-start" (click)="goToCustomers()">
                        <mat-icon>people</mat-icon>
                        <span class="ml-2">Gestisci Clienti</span>
                    </button>
                    <button mat-stroked-button class="w-full justify-start" routerLink="/settings">
                        <mat-icon>settings</mat-icon>
                        <span class="ml-2">Impostazioni</span>
                    </button>
                    <button mat-stroked-button class="w-full justify-start" routerLink="/help">
                        <mat-icon>help</mat-icon>
                        <span class="ml-2">Centro Assistenza</span>
                    </button>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
    }
</div>