<div class="customers-container animate-fade-in">
    <!-- Page Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-on-surface mb-2">Clienti</h1>
            <p class="text-on-surface-variant">
                Gestisci i tuoi clienti e contatti
                @if (hasActiveFilters()) {
                <span class="ml-2 text-primary font-medium">
                    ({{ getFilteredCount() }} di {{ customers().length }} risultati)
                </span>
                }
            </p>
        </div>
        <button mat-raised-button color="primary" (click)="openCustomerDialog()">
            <mat-icon>person_add</mat-icon>
            Nuovo Cliente
        </button>
    </div>

    <!-- Search and Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
        <!-- Search -->
        <mat-card class="surface-container md:col-span-2">
            <mat-card-content class="p-4">
                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Cerca cliente</mat-label>
                    <input matInput [ngModel]="searchQuery()" (ngModelChange)="searchQuery.set($event); applyFilter()"
                        placeholder="Nome, email, telefono, CF o P.IVA">
                    <mat-icon matSuffix>search</mat-icon>
                    @if (searchQuery()) {
                    <button matSuffix mat-icon-button (click)="clearFilter()" matTooltip="Pulisci ricerca">
                        <mat-icon>clear</mat-icon>
                    </button>
                    }
                </mat-form-field>
            </mat-card-content>
        </mat-card>

        <!-- Quick Stats -->
        <mat-card class="surface-container">
            <mat-card-content class="p-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-2xl font-bold text-on-surface">{{ customers().length }}</p>
                        <p class="text-sm text-on-surface-variant">Clienti totali</p>
                    </div>
                    <mat-icon class="text-4xl text-primary">groups</mat-icon>
                </div>
            </mat-card-content>
        </mat-card>
    </div>

    <!-- Customers Table -->
    <mat-card class="surface-container">
        <mat-card-content class="p-0">
            @if (loading()) {
            <div class="flex justify-center items-center py-16">
                <mat-spinner diameter="40"></mat-spinner>
            </div>
            } @else if (filteredCustomers().length > 0) {
            <div class="overflow-x-auto">
                <table mat-table [dataSource]="filteredCustomers()" class="w-full">
                    <!-- Name Column -->
                    <ng-container matColumnDef="name">
                        <th mat-header-cell *matHeaderCellDef class="font-semibold">Cliente</th>
                        <td mat-cell *matCellDef="let customer">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center">
                                    <mat-icon class="text-primary">
                                        {{ customer.vat_number ? 'business' : 'person' }}
                                    </mat-icon>
                                </div>
                                <div>
                                    <p class="font-medium text-on-surface">{{ customer.name }}</p>
                                    @if (getCustomerStats(customer.id)) {
                                    <div class="flex items-center gap-2 text-xs text-on-surface-variant">
                                        <span>{{ getCustomerStats(customer.id).totalInvoices }} fatture</span>
                                        <span>•</span>
                                        <span>€{{ getCustomerStats(customer.id).totalAmount | number:'1.2-2' }}</span>
                                    </div>
                                    }
                                </div>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Contact Column -->
                    <ng-container matColumnDef="contact">
                        <th mat-header-cell *matHeaderCellDef class="font-semibold">Contatti</th>
                        <td mat-cell *matCellDef="let customer">
                            <div class="space-y-1">
                                @if (customer.email) {
                                <div class="flex items-center gap-1">
                                    <mat-icon class="text-sm text-on-surface-variant">email</mat-icon>
                                    <a [href]="'mailto:' + customer.email" class="text-sm text-primary hover:underline"
                                        (click)="$event.stopPropagation()">
                                        {{ customer.email }}
                                    </a>
                                </div>
                                }
                                @if (customer.phone) {
                                <div class="flex items-center gap-1">
                                    <mat-icon class="text-sm text-on-surface-variant">phone</mat-icon>
                                    <a [href]="'tel:' + customer.phone" class="text-sm text-on-surface"
                                        (click)="$event.stopPropagation()">
                                        {{ customer.phone }}
                                    </a>
                                </div>
                                }
                                @if (!customer.email && !customer.phone) {
                                <span class="text-sm text-on-surface-variant">-</span>
                                }
                            </div>
                        </td>
                    </ng-container>

                    <!-- Tax Info Column -->
                    <ng-container matColumnDef="tax_info">
                        <th mat-header-cell *matHeaderCellDef class="font-semibold">Dati Fiscali</th>
                        <td mat-cell *matCellDef="let customer">
                            <div class="space-y-1">
                                @if (customer.tax_code) {
                                <div class="text-sm">
                                    <span class="text-on-surface-variant">CF:</span>
                                    <span class="text-on-surface ml-1 font-mono">{{ customer.tax_code }}</span>
                                </div>
                                }
                                @if (customer.vat_number) {
                                <div class="text-sm">
                                    <span class="text-on-surface-variant">P.IVA:</span>
                                    <span class="text-on-surface ml-1 font-mono">{{ customer.vat_number }}</span>
                                </div>
                                }
                                @if (!customer.tax_code && !customer.vat_number) {
                                <span class="text-sm text-on-surface-variant">-</span>
                                }
                            </div>
                        </td>
                    </ng-container>

                    <!-- Address Column -->
                    <ng-container matColumnDef="address">
                        <th mat-header-cell *matHeaderCellDef class="font-semibold">Indirizzo</th>
                        <td mat-cell *matCellDef="let customer">
                            @if (customer.address) {
                            <p class="text-sm text-on-surface line-clamp-2" [matTooltip]="customer.address"
                                matTooltipPosition="above">
                                {{ customer.address }}
                            </p>
                            } @else {
                            <span class="text-sm text-on-surface-variant">-</span>
                            }
                        </td>
                    </ng-container>

                    <!-- Actions Column -->
                    <ng-container matColumnDef="actions">
                        <th mat-header-cell *matHeaderCellDef class="font-semibold text-right">Azioni</th>
                        <td mat-cell *matCellDef="let customer" class="text-right">
                            <button mat-icon-button [matMenuTriggerFor]="actionsMenu"
                                [matMenuTriggerData]="{customer: customer}" (click)="stopEventPropagation($event)">
                                <mat-icon>more_vert</mat-icon>
                            </button>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let customer; columns: displayedColumns;"
                        class="hover:bg-surface-container-high cursor-pointer" (click)="viewCustomerInvoices(customer)">
                    </tr>
                </table>
            </div>
            } @else {
            <div class="text-center py-16">
                <mat-icon class="text-8xl text-on-surface-variant mb-4">people_outline</mat-icon>
                <h3 class="text-xl font-semibold text-on-surface mb-2">
                    {{ searchQuery() ? 'Nessun cliente trovato' : 'Nessun cliente ancora' }}
                </h3>
                <p class="text-on-surface-variant mb-6">
                    {{ searchQuery() ?
                    'Prova a modificare i criteri di ricerca' :
                    'Inizia aggiungendo il tuo primo cliente' }}
                </p>
                @if (!searchQuery()) {
                <button mat-raised-button color="primary" (click)="openCustomerDialog()">
                    <mat-icon>person_add</mat-icon>
                    Aggiungi Cliente
                </button>
                }
            </div>
            }
        </mat-card-content>
    </mat-card>

    <!-- Actions Menu -->
    <mat-menu #actionsMenu="matMenu">
        <ng-template matMenuContent let-customer="customer">
            <button mat-menu-item (click)="editCustomer(customer)">
                <mat-icon>edit</mat-icon>
                <span>Modifica</span>
            </button>
            <button mat-menu-item (click)="viewCustomerInvoices(customer)">
                <mat-icon>receipt_long</mat-icon>
                <span>Vedi Fatture</span>
            </button>
            <button mat-menu-item (click)="createInvoiceForCustomer(customer)">
                <mat-icon>add_circle</mat-icon>
                <span>Crea Fattura</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="deleteCustomer(customer)" class="text-error">
                <mat-icon>delete</mat-icon>
                <span>Elimina</span>
            </button>
        </ng-template>
    </mat-menu>
</div>